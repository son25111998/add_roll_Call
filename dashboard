<?php
// File: admin/dashboard.php

if (session_status() === PHP_SESSION_NONE) {
    session_start();
}

$project_root = $_SERVER['DOCUMENT_ROOT'];

require_once __DIR__ . '/../includes/config.php';
require_once __DIR__ . '/../../config/dbh.inc.php';
require_once __DIR__ . '/../includes/admin.function.inc.php';
require_once __DIR__ . '/../includes/action.function.inc.php';

if (!isset($_SESSION['admin_id'])) {
    header("location: " . BASE_URL . "admin/");
    exit();
}

$valid_tabs = ['overview', 'accounts', 'tuition', 'packages', 'salary', 'bonus'];
$active_tab = (isset($_GET['tab']) && in_array($_GET['tab'], $valid_tabs)) ? $_GET['tab'] : 'overview';
$month = $_GET['month'] ?? date('Y-m');

// Lấy dữ liệu chung
$system_message = $_SESSION['system_message'] ?? null;
unset($_SESSION['system_message']);
$invoice_report = $_SESSION['invoice_report'] ?? null;
unset($_SESSION['invoice_report']);

// Lấy dữ liệu cho các tab
$overview_stats = getOverviewStats($conn);
$revenue_data = getRevenueByClassForMonth($conn, $month);
$accounts_data = getAccountsGroupedByClass($conn);
$tuition_data = getTuitionStatusByClass($conn, $month);
$salary_month = $_GET['salary_month'] ?? date('Y-m');
$salary_report = getSalaryReportForMonth($conn, $salary_month);
$tuition_summary = getTuitionSummaryForMonth($conn, $month);
$all_other_fees = getOtherFees($conn);
$all_teachers = adminGetAllTeachers($conn);
$all_teachers_bonus = adminGetAllTeacherBonus($conn);
$all_students = getAllStudentsWithParentInfo($conn);
$unassigned_students = getUnassignedStudents($conn);
// *** THAY ĐỔI: Gọi hàm mới để lấy dữ liệu cho tab tài khoản ***
$accounts_data = getAccountManagementData($conn);
$tuition_data = getTuitionStatusByClass($conn, $month);
$pending_payments = getPendingPayments($conn);
?>
<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://kit.fontawesome.com/84ae347da1.js" crossorigin="anonymous"></script>
    <style>
        .card {
            border-radius: 0.75rem;
        }

        .nav-tabs .nav-link.active {
            color: #00796b;
            font-weight: 600;
        }

        .info-card {
            background-color: #e0f2f1;
            border-left: 5px solid #00796b;
        }

        .chart-container {
            height: 400px;
        }

        .select2-container .select2-selection--single {
            height: 38px;
        }

        /* *** THÊM MỚI: CSS để tô sáng học sinh được chọn *** */
        .list-group-item-action.selected {
            background-color: #d_df_f5 !important;
            /* Màu xanh nhạt của Bootstrap */
            color: #0d6efd !important;
            font-weight: bold;
        }
    </style>
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Admin Panel</a>
            <a class="nav-link text-white" href="<?= BASE_URL ?>includes/logout.inc.php">Đăng xuất</a>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Hiển thị thông báo hệ thống -->
        <?php if ($system_message): ?>
            <div class="alert alert-<?= $system_message['type'] ?> alert-dismissible fade show" role="alert">
                <?= htmlspecialchars($system_message['message']) ?>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        <?php endif; ?>
        <?php if ($invoice_report): ?>
            <div class="alert alert-info alert-dismissible fade show" role="alert">
                <strong>Báo cáo tạo hóa đơn:</strong>
                <?= sprintf(
                    "Tạo mới: %d. Cập nhật: %d. Thất bại: %d. Không có buổi học: %d.",
                    $invoice_report['created'],
                    $invoice_report['updated'],
                    $invoice_report['failed'],
                    $invoice_report['no_session']
                ) ?>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        <?php endif; ?>

        <!-- Thanh điều hướng Tab -->
        <ul class="nav nav-tabs" id="adminTab" role="tablist">
            <li class="nav-item" role="presentation">
                <a class="nav-link <?= $active_tab === 'overview' ? 'active' : '' ?>" href="?tab=overview">Tổng quan</a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link <?= $active_tab === 'accounts' ? 'active' : '' ?>" href="?tab=accounts">Quản lý Tài khoản</a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link <?= $active_tab === 'tuition' ? 'active' : '' ?>" href="?tab=tuition">Học phí & Hóa đơn</a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link <?= $active_tab === 'packages' ? 'active' : '' ?>" href="?tab=packages">Quản lý Gói học phí</a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link <?= $active_tab === 'salary' ? 'active' : '' ?>" href="?tab=salary">Tính lương</a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link <?= $active_tab === 'bonus' ? 'active' : '' ?>" href="?tab=bonus">Quản lý thưởng</a>
            </li>
        </ul>

        <!-- Nội dung các Tab -->
        <div class="tab-content pt-3">
            <div class="tab-pane fade <?= $active_tab === 'overview' ? 'show active' : '' ?>" role="tabpanel">
                <?php if ($active_tab === 'overview') include __DIR__ . '/tabs/_overview_tab.php'; ?>
            </div>
            <div class="tab-pane fade <?= $active_tab === 'accounts' ? 'show active' : '' ?>" role="tabpanel">
                <?php if ($active_tab === 'accounts') include __DIR__ . '/tabs/_accounts_tab.php'; ?>
            </div>
            <div class="tab-pane fade <?= $active_tab === 'tuition' ? 'show active' : '' ?>" role="tabpanel">
                <?php if ($active_tab === 'tuition') include __DIR__ . '/tabs/_tuition_tab.php'; ?>
            </div>
            <div class="tab-pane fade <?= $active_tab === 'packages' ? 'show active' : '' ?>" role="tabpanel">
                <?php if ($active_tab === 'packages') include __DIR__ . '/tabs/_packages_tab.php'; ?>
            </div>
            <div class="tab-pane fade <?= $active_tab === 'salary' ? 'show active' : '' ?>" role="tabpanel">
                <?php if ($active_tab === 'salary') include __DIR__ . '/tabs/_salary_tab.php'; ?>
            </div>
            <div class="tab-pane fade <?= $active_tab === 'bonus' ? 'show active' : '' ?>" role="tabpanel">
                <?php if ($active_tab === 'bonus') include __DIR__ . '/tabs/_bonus_tab.php'; ?>
            </div>
        </div>
    </div>

    <?php include __DIR__ . '/tabs/_modals.php'; ?>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <?php include __DIR__ . '/tabs/_scripts.php'; ?>
</body>

</html>
